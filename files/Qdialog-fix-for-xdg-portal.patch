From f05cc4144e06fd06eed12a3e427eb49e7ad1cf85 Mon Sep 17 00:00:00 2001
From: Alexander Volkov <a.volkov@rusbitech.ru>
Date: Tue, 18 Dec 2018 16:49:20 +0300
Subject: [PATCH] QDialog: Pass transient parent as a parent to native dialogs
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Sometimes it's needed to show a native dialog for another process,
for example in xdg-desktop-portal-kde. In this case we have WId
of a parent window which can be used for calling
QWindow::setTransientParent(QWindow::fromWinId(...)).

Pass this transient parent to a native dialog so it could use
it as a transient parent for itself. Rename
QDialogPrivate::parentWindow() for clarity.

Change-Id: I68974ddea35f9366a0ddffe602d9d028f45e26fa
Reviewed-by: Tor Arne Vestb√∏ <tor.arne.vestbo@qt.io>
---
 src/widgets/dialogs/qdialog.cpp | 9 ++++++---
 src/widgets/dialogs/qdialog_p.h | 2 +-
 2 files changed, 7 insertions(+), 4 deletions(-)

diff --git a/src/widgets/dialogs/qdialog.cpp b/src/widgets/dialogs/qdialog.cpp
index 06f0393b4c..6f96018f3e 100644
--- a/src/widgets/dialogs/qdialog.cpp
+++ b/src/widgets/dialogs/qdialog.cpp
@@ -145,10 +145,13 @@ bool QDialogPrivate::canBeNativeDialog() const
     return false;
 }
 
-QWindow *QDialogPrivate::parentWindow() const
+QWindow *QDialogPrivate::transientParentWindow() const
 {
-    if (const QWidget *parent = q_func()->nativeParentWidget())
+    Q_Q(const QDialog);
+    if (const QWidget *parent = q->nativeParentWidget())
         return parent->windowHandle();
+    else if (q->windowHandle())
+        return q->windowHandle()->transientParent();
     return 0;
 }
 
@@ -158,7 +161,7 @@ bool QDialogPrivate::setNativeDialogVisible(bool visible)
         if (visible) {
             Q_Q(QDialog);
             helperPrepareShow(helper);
-            nativeDialogInUse = helper->show(q->windowFlags(), q->windowModality(), parentWindow());
+            nativeDialogInUse = helper->show(q->windowFlags(), q->windowModality(), transientParentWindow());
         } else if (nativeDialogInUse) {
             helper->hide();
         }
diff --git a/src/widgets/dialogs/qdialog_p.h b/src/widgets/dialogs/qdialog_p.h
index 99fff08e65..b1de56188c 100644
--- a/src/widgets/dialogs/qdialog_p.h
+++ b/src/widgets/dialogs/qdialog_p.h
@@ -87,7 +87,7 @@ class Q_WIDGETS_EXPORT QDialogPrivate : public QWidgetPrivate
         {}
     ~QDialogPrivate();
 
-    QWindow *parentWindow() const;
+    QWindow *transientParentWindow() const;
     bool setNativeDialogVisible(bool visible);
     QVariant styleHint(QPlatformDialogHelper::StyleHint hint) const;
     void deletePlatformHelper();
